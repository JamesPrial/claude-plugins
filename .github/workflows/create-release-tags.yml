# Workflow 3 of 3: Auto Semantic Versioning
# Receives version map, creates git tags for each bumped plugin
#
# Triggered by: repository_dispatch event "create-tags" from bump-plugin-versions.yml
# Payload: { version_map: {"plugin1": "1.0.2", "plugin2": "1.0.1"}, commit_sha: "..." }
#
# Flow: Receive dispatch → create git tags → push tags

name: Create Release Tags

on:
  repository_dispatch:
    types: [create-tags]

concurrency:
  group: create-tags
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  tag:
    name: Create & Push Tags
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.VERSION_PAT }}
          fetch-depth: 0  # Need full history for proper tagging
          ref: main  # Ensure we're on latest main with version bump commit

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Pull latest changes
        run: |
          # Ensure we have the version bump commit
          git pull origin main

      - name: Create tags
        id: tags
        run: |
          VERSION_MAP='${{ toJson(github.event.client_payload.version_map) }}'

          echo "Version map: $VERSION_MAP"

          CREATED_TAGS=()
          SKIPPED_TAGS=()

          for plugin in $(echo "$VERSION_MAP" | jq -r 'keys[]'); do
            VERSION=$(echo "$VERSION_MAP" | jq -r --arg p "$plugin" '.[$p]')
            TAG="${plugin}@v${VERSION}"

            echo "Processing tag: $TAG"

            # Check if tag already exists
            if git tag -l "$TAG" | grep -q .; then
              echo "::warning::Tag $TAG already exists, skipping"
              SKIPPED_TAGS+=("$TAG")
              continue
            fi

            # Create annotated tag
            git tag -a "$TAG" -m "Release ${plugin} v${VERSION}

Auto-generated by GitHub Actions workflow.
Trigger commit: ${{ github.event.client_payload.trigger_sha }}"

            echo "Created tag: $TAG"
            CREATED_TAGS+=("$TAG")
          done

          # Output results
          echo "created_tags=${CREATED_TAGS[*]}" >> $GITHUB_OUTPUT
          echo "skipped_tags=${SKIPPED_TAGS[*]}" >> $GITHUB_OUTPUT
          echo "created_count=${#CREATED_TAGS[@]}" >> $GITHUB_OUTPUT

      - name: Push tags
        if: steps.tags.outputs.created_count != '0'
        run: |
          echo "Pushing tags to origin..."
          git push origin --tags

      - name: Summary
        run: |
          echo "## Create Release Tags Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Created Tags" >> $GITHUB_STEP_SUMMARY
          CREATED="${{ steps.tags.outputs.created_tags }}"
          if [ -n "$CREATED" ]; then
            for tag in $CREATED; do
              echo "- \`$tag\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "_No tags created_" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Skipped Tags (already exist)" >> $GITHUB_STEP_SUMMARY
          SKIPPED="${{ steps.tags.outputs.skipped_tags }}"
          if [ -n "$SKIPPED" ]; then
            for tag in $SKIPPED; do
              echo "- \`$tag\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "_None skipped_" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger commit:** \`${{ github.event.client_payload.trigger_sha }}\`" >> $GITHUB_STEP_SUMMARY
